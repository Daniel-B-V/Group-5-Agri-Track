<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Donate Crops</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet"/>
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      padding: 0;
      color: #333;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background-color: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .go-back-btn {
      display: flex;
      align-items: center;
      background-color: #367952;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      text-decoration: none;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }

    .go-back-btn:hover {
      background-color: #2a6142;
    }

    .go-back-btn span {
      margin-right: 8px;
      font-size: 20px;
    }

    .container {
      max-width: 900px;
      margin: 30px auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 20px;
      border-bottom: 2px solid #367952;
      padding-bottom: 10px;
      color: #367952;
    }

    .community-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
    }

    .community-card {
      display: flex;
      flex-direction: column;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      height: 100%;
    }

    .community-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
    }

    .community-image {
      height: 160px;
      background-color: #f0f4f8;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #367952;
    }

    .community-image span {
      font-size: 70px;
      transition: transform 0.3s ease;
    }

    .community-card:hover .community-image span {
      transform: scale(1.1);
    }

    .community-info {
      padding: 20px;
      display: flex;
      flex-direction: column;
      flex-grow: 1;
    }

    .community-name {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
      color: #367952;
      line-height: 1.3;
    }

    .community-location {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }

    .community-location span {
      margin-right: 8px;
      font-size: 18px;
      color: #4a4a4a;
    }

    .community-description {
      font-size: 14px;
      color: #555;
      margin-bottom: 25px;
      line-height: 1.5;
      flex-grow: 1;
    }

    .donate-btn {
      background-color: #367952;
      color: white;
      border: none;
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
      transition: all 0.3s ease;
      font-size: 15px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .donate-btn:hover {
      background-color: #2a6142;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .add-community-btn {
      background-color: #4f35a1;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-bottom: 25px;
      display: inline-flex;
      align-items: center;
      transition: all 0.3s ease;
      font-size: 15px;
    }

    .add-community-btn:hover {
      background-color: #3a2678;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .add-community-btn span {
      margin-right: 8px;
      font-size: 20px;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      backdrop-filter: blur(3px);
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background-color: #fefefe;
      margin: 7% auto;
      padding: 25px;
      border: none;
      width: 90%;
      max-width: 450px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .close:hover {
      color: #555;
    }

    .modal-title {
      margin-top: 0;
      color: #367952;
      font-size: 22px;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }

    .modal-input {
      width: 100%;
      padding: 12px;
      margin: 8px 0 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-sizing: border-box;
      font-family: 'Montserrat', sans-serif;
      transition: border-color 0.3s ease;
    }

    .modal-input:focus {
      border-color: #367952;
      outline: none;
      box-shadow: 0 0 0 2px rgba(54, 121, 82, 0.2);
    }

    .modal-select {
      width: 100%;
      padding: 12px;
      margin: 8px 0 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background-color: white;
      font-family: 'Montserrat', sans-serif;
      transition: border-color 0.3s ease;
    }

    .modal-select:focus {
      border-color: #367952;
      outline: none;
      box-shadow: 0 0 0 2px rgba(54, 121, 82, 0.2);
    }

    .modal-button {
      background-color: #367952;
      color: white;
      padding: 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-top: 15px;
      width: 100%;
      transition: all 0.3s ease;
      font-family: 'Montserrat', sans-serif;
    }

    .modal-button:hover {
      background-color: #2a6142;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .quantity-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
      font-size: 14px;
    }

    /* Instruction Modal Styles */
    .instruction-modal {
      display: none;
      position: fixed;
      z-index: 1100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
    }

    .instruction-content {
      background-color: #f8f9fa;
      margin: 10% auto;
      padding: 30px;
      border-radius: 12px;
      width: 90%;
      max-width: 550px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      animation: slideUp 0.4s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .instruction-title {
      color: #367952;
      margin-top: 0;
      font-size: 24px;
      border-bottom: 2px solid #367952;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }

    .instruction-text {
      margin: 20px 0;
      line-height: 1.6;
      color: #444;
    }

    .instruction-button {
      background-color: #367952;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      display: block;
      margin: 25px auto 0;
      transition: all 0.3s ease;
    }

    .instruction-button:hover {
      background-color: #2a6142;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .instruction-list {
      margin: 15px 0;
      padding-left: 20px;
    }

    .instruction-list li {
      margin-bottom: 10px;
      color: #444;
    }

    .icon-selector {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin: 15px 0 20px;
    }

    .icon-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 5px;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .icon-option:hover {
      border-color: #367952;
      background-color: #f8f9fa;
    }

    .icon-option.selected {
      border-color: #367952;
      background-color: #f0f7f3;
      transform: scale(1.05);
    }

    .icon-option span {
      font-size: 28px;
      margin-bottom: 5px;
      color: #367952;
    }

    .icon-option small {
      font-size: 12px;
      color: #666;
      text-align: center;
    }

    .top-alert {
      position: fixed;
      top: -100px;
      left: 0;
      right: 0;
      padding: 15px;
      text-align: center;
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
      z-index: 1000;
      transition: top 0.4s ease;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    .top-alert.show {
      top: 0;
    }

    .top-alert.error {
      background-color: #f44336;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .container {
        margin: 15px;
        padding: 20px;
      }
      
      .community-grid {
        grid-template-columns: 1fr;
      }
      
      .modal-content {
        margin: 20% auto;
        width: 85%;
      }
    }

    @media (max-width: 480px) {
      .icon-selector {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .modal-content {
        margin: 25% auto;
        padding: 20px;
      }
    }
</style>
</head>
<body>
  <!-- Instruction Modal -->
  <div id="instructionModal" class="instruction-modal">
    <div class="instruction-content">
      <h2 class="instruction-title">Welcome to Donation Center</h2>
      <div class="instruction-text">
        <p>This section helps you donate your excess crops to communities in need. Here's how to use it:</p>
        <ul class="instruction-list">
          <li><strong>Browse communities</strong> that need help across the Philippines</li>
          <li><strong>Click "Donate Crops"</strong> to select which crops and how much to give</li>
          <li><strong>Add new communities</strong> if you know of organizations that need support</li>
          <li>Only crops you have available (harvested - consumed - donated) will be shown</li>
          <li>Your donations will be tracked in your dashboard reports</li>
        </ul>
        <p>Thank you for helping communities in need!</p>
      </div>
      <button class="instruction-button" onclick="closeInstructionModal()">Got it!</button>
    </div>
  </div>

  <!-- Donation Modal -->
  <div id="donationModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('donationModal')">&times;</span>
      <h2 class="modal-title" id="donationModalTitle">Donate to <span id="communityName"></span></h2>
      
      <label for="donationCrop" class="quantity-label">Select Crop:</label>
      <select id="donationCrop" class="modal-select">
        <!-- Will be populated with available crops -->
      </select>
      
      <label for="donationQuantity" class="quantity-label">Quantity (pieces):</label>
      <input 
        type="number" 
        id="donationQuantity" 
        class="modal-input" 
        placeholder="Enter quantity (pcs)" 
        min="1" 
        step="1"
        oninput="this.value = Math.abs(this.value)"
      >
      
      <label for="donationDate" class="quantity-label">Donation Date:</label>
      <input 
        type="date" 
        id="donationDate" 
        class="modal-input" 
        value="<?php echo date('Y-m-d'); ?>"
      >
      
      <button class="modal-button" onclick="submitDonation()">Submit Donation</button>
    </div>
  </div>

  <!-- Add Community Modal -->
  <div id="addCommunityModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('addCommunityModal')">&times;</span>
      <h2 class="modal-title">Add New Community</h2>
      
      <label for="newCommunityName" class="quantity-label">Community Name:</label>
      <input 
        type="text" 
        id="newCommunityName" 
        class="modal-input" 
        placeholder="Enter community name"
      >
      
      <label for="newCommunityLocation" class="quantity-label">Location:</label>
      <input 
        type="text" 
        id="newCommunityLocation" 
        class="modal-input" 
        placeholder="Enter location (City/Province)"
      >
      
      <label for="newCommunityDescription" class="quantity-label">Description:</label>
      <textarea 
        id="newCommunityDescription" 
        class="modal-input" 
        placeholder="Describe who this community helps"
        rows="3"
      ></textarea>
      
      <label class="quantity-label">Select Icon:</label>
      <div class="icon-selector" id="iconSelector">
        <div class="icon-option" onclick="selectIcon(this, 'restaurant')">
          <span class="material-icons-outlined">restaurant</span>
          <small>Kitchen</small>
        </div>
        <div class="icon-option" onclick="selectIcon(this, 'child_care')">
          <span class="material-icons-outlined">child_care</span>
          <small>Children</small>
        </div>
        <div class="icon-option" onclick="selectIcon(this, 'elderly')">
          <span class="material-icons-outlined">elderly</span>
          <small>Elderly</small>
        </div>
        <div class="icon-option" onclick="selectIcon(this, 'directions_boat')">
          <span class="material-icons-outlined">directions_boat</span>
          <small>Fisherfolk</small>
        </div>
        <div class="icon-option" onclick="selectIcon(this, 'warning')">
          <span class="material-icons-outlined">warning</span>
          <small>Disaster</small>
        </div>
        <div class="icon-option" onclick="selectIcon(this, 'forest')">
          <span class="material-icons-outlined">forest</span>
          <small>Indigenous</small>
        </div>
        <div class="icon-option" onclick="selectIcon(this, 'home')">
          <span class="material-icons-outlined">home</span>
          <small>Shelter</small>
        </div>
        <div class="icon-option" onclick="selectIcon(this, 'local_hospital')">
          <span class="material-icons-outlined">local_hospital</span>
          <small>Hospital</small>
        </div>
      </div>
      <input type="hidden" id="selectedIcon" value="restaurant">
      
      <button class="modal-button" onclick="addNewCommunity()">Add Community</button>
    </div>
  </div>

  <!-- Header with Back Button -->
  <div class="header">
    <a href="index.html" class="go-back-btn">
      <span class="material-icons-outlined">arrow_back</span>
      Go Back
    </a>
  </div>

  <div class="container">
    <h1>Donate to Communities</h1>
    <p>Select a community to donate your excess crops and help those in need.</p>
    
    <button class="add-community-btn" onclick="openAddCommunityModal()">
      <span class="material-icons-outlined">add</span>
      Add New Community
    </button>
    
    <div class="community-grid" id="communitiesGrid">
      <!-- Communities will be added here dynamically -->
    </div>
  </div>

  <script>
    // Storage keys
    const STORAGE_KEY = 'cropTrackerData';
    const COMMUNITIES_STORAGE_KEY = 'cropTrackerCommunities';
    const NOTIFICATIONS_KEY = 'notifications'; // Changed to match dashboard
    
    // Default communities
    const defaultCommunities = [
      {
        id: 1,
        name: "Tondo Community Kitchen",
        location: "Manila",
        description: "Provides meals to underprivileged families in Tondo area.",
        icon: "restaurant"
      },
      {
        id: 2,
        name: "Payatas Orphanage",
        location: "Quezon City",
        description: "Cares for orphaned and abandoned children in Payatas.",
        icon: "child_care"
      },
      {
        id: 3,
        name: "Marikina Senior Center",
        location: "Marikina",
        description: "Supports elderly citizens with daily meals and activities.",
        icon: "elderly"
      },
      {
        id: 4,
        name: "Navotas Fisherfolk",
        location: "Navotas",
        description: "Helps fisherfolk families affected by seasonal changes.",
        icon: "directions_boat"
      },
      {
        id: 5,
        name: "Batangas Evacuees",
        location: "Batangas",
        description: "Supports families displaced by natural disasters.",
        icon: "warning"
      },
      {
        id: 6,
        name: "Baguio Indigenous Community",
        location: "Baguio",
        description: "Assists indigenous communities with food supplies.",
        icon: "forest"
      }
    ];

    // Current selected community
    let currentCommunity = null;
    let nextCommunityId = 7; // Starting after default communities

    // Initialize the page
    window.onload = function() {
      // Initialize communities in localStorage if not already present
      if (!localStorage.getItem(COMMUNITIES_STORAGE_KEY)) {
        localStorage.setItem(COMMUNITIES_STORAGE_KEY, JSON.stringify(defaultCommunities));
      }
      
      renderCommunities();
      
      // Show instruction modal on first visit
      if (!localStorage.getItem('hasSeenInstructions')) {
        document.getElementById('instructionModal').style.display = 'block';
        localStorage.setItem('hasSeenDonationInstructions', 'true');
      }
    };

    // Close instruction modal
    function closeInstructionModal() {
      document.getElementById('instructionModal').style.display = 'none';
    }

    // Get communities from localStorage
    function getCommunities() {
      const communities = localStorage.getItem(COMMUNITIES_STORAGE_KEY);
      return communities ? JSON.parse(communities) : [];
    }

    // Save communities to localStorage
    function saveCommunities(communities) {
      localStorage.setItem(COMMUNITIES_STORAGE_KEY, JSON.stringify(communities));
    }

    // Render communities to the page
    function renderCommunities() {
      const grid = document.getElementById('communitiesGrid');
      grid.innerHTML = '';
      
      const communities = getCommunities();
      
      communities.forEach(community => {
        const card = document.createElement('div');
        card.className = 'community-card';
        card.innerHTML = `
          <div class="community-image">
            <span class="material-icons-outlined">${community.icon}</span>
          </div>
          <div class="community-info">
            <div class="community-name">${community.name}</div>
            <div class="community-location">
              <span class="material-icons-outlined">location_on</span>
              ${community.location}
            </div>
            <div class="community-description">${community.description}</div>
            <button class="donate-btn" onclick="openDonationModal(${community.id})">Donate Crops</button>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    // Open donation modal
    function openDonationModal(communityId) {
      const communities = getCommunities();
      currentCommunity = communities.find(c => c.id === communityId);
      
      if (!currentCommunity) return;
      
      // Set community name in modal
      document.getElementById('communityName').textContent = currentCommunity.name;
      
      // Populate crops dropdown with available crops from harvest
      populateCropDropdown();
      
      // Show modal
      document.getElementById('donationModal').style.display = 'block';
    }

    // Populate crop dropdown with available crops
    function populateCropDropdown() {
      const dropdown = document.getElementById('donationCrop');
      dropdown.innerHTML = '';
      
      // Get available crops from harvest data
      const availableCrops = getAvailableCrops();
      
      if (availableCrops.length === 0) {
        dropdown.innerHTML = '<option value="">No crops available for donation</option>';
        return;
      }
      
      availableCrops.forEach(crop => {
        const option = document.createElement('option');
        option.value = crop.name;
        option.textContent = `${crop.name} (Available: ${crop.quantity})`;
        dropdown.appendChild(option);
      });
    }

    // Get available crops from harvest data (minus consumed and donated)
    function getAvailableCrops() {
      const data = getStoredData();
      
      // Calculate total harvested
      const harvested = {};
      if (data.harvest && data.harvest.length > 0) {
        data.harvest.forEach(item => {
          if (!harvested[item.crop]) harvested[item.crop] = 0;
          harvested[item.crop] += item.quantity;
        });
      }
      
      // Calculate total consumed
      const consumed = {};
      if (data.consumed && data.consumed.length > 0) {
        data.consumed.forEach(item => {
          if (!consumed[item.crop]) consumed[item.crop] = 0;
          consumed[item.crop] += item.quantity;
        });
      }
      
      // Calculate total donated
      const donated = {};
      if (data.donated && data.donated.length > 0) {
        data.donated.forEach(item => {
          if (!donated[item.crop]) donated[item.crop] = 0;
          donated[item.crop] += item.quantity;
        });
      }
      
      // Calculate available crops
      const available = [];
      for (const crop in harvested) {
        const availableQty = harvested[crop] - 
                            (consumed[crop] || 0) - 
                            (donated[crop] || 0);
        if (availableQty > 0) {
          available.push({
            name: crop,
            quantity: availableQty
          });
        }
      }
      
      return available;
    }

    // Submit donation
    function submitDonation() {
      const crop = document.getElementById('donationCrop').value;
      const quantity = parseInt(document.getElementById('donationQuantity').value);
      const date = document.getElementById('donationDate').value;
      
      if (!crop || crop === "") {
        showTopAlert('Please select a crop', 'error');
        return;
      }
      
      if (!quantity || quantity <= 0) {
        showTopAlert('Please enter valid quantity', 'error');
        return;
      }
      
      // Check if donation quantity is available
      const availableCrops = getAvailableCrops();
      const selectedCrop = availableCrops.find(c => c.name === crop);
      
      if (!selectedCrop || quantity > selectedCrop.quantity) {
        showTopAlert(`You only have ${selectedCrop ? selectedCrop.quantity : 0} ${crop} available for donation`, 'error');
        return;
      }
      
      // Add to donated items - this will trigger the notification
      addDonatedItem(
        crop, 
        quantity, 
        new Date(date), 
        currentCommunity.name, 
        currentCommunity.location
      );
      
      // Show success message
      showTopAlert(`Successfully donated ${quantity} ${crop} to ${currentCommunity.name}!`);
      
      // Close the modal
      closeModal('donationModal');
      
      // Update the available crops list
      populateCropDropdown();
    }

    // Open add community modal
    function openAddCommunityModal() {
      // Reset form
      document.getElementById('newCommunityName').value = '';
      document.getElementById('newCommunityLocation').value = '';
      document.getElementById('newCommunityDescription').value = '';
      document.getElementById('selectedIcon').value = 'restaurant';
      
      // Reset icon selection
      const icons = document.querySelectorAll('.icon-option');
      icons.forEach(icon => icon.classList.remove('selected'));
      icons[0].classList.add('selected');
      
      document.getElementById('addCommunityModal').style.display = 'block';
    }

    // Select icon for new community
    function selectIcon(element, iconValue) {
      // Remove selected class from all icons
      const icons = document.querySelectorAll('.icon-option');
      icons.forEach(icon => icon.classList.remove('selected'));
      
      // Add selected class to clicked icon
      element.classList.add('selected');
      document.getElementById('selectedIcon').value = iconValue;
    }

    // Add new community
    function addNewCommunity() {
      const name = document.getElementById('newCommunityName').value.trim();
      const location = document.getElementById('newCommunityLocation').value.trim();
      const description = document.getElementById('newCommunityDescription').value.trim();
      const icon = document.getElementById('selectedIcon').value;
      
      if (!name) {
        showTopAlert('Please enter community name', 'error');
        return;
      }
      
      if (!location) {
        showTopAlert('Please enter a location', 'error');
        return;
      }
      
      if (!description) {
        showTopAlert('Please enter a description', 'error');
        return;
      }
      
      const communities = getCommunities();
      const newCommunity = {
        id: nextCommunityId++,
        name,
        location,
        description,
        icon
      };
      
      communities.push(newCommunity);
      saveCommunities(communities);
      renderCommunities();
      
      showTopAlert(`Added new community: ${name}`);
      closeModal('addCommunityModal');
    }

    // Close modal
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    // Data Storage and Management
    function getStoredData() {
      const data = localStorage.getItem(STORAGE_KEY);
      return data ? JSON.parse(data) : {
        consumed: [],
        harvest: [],
        donated: [],
        lastUpdated: new Date().toISOString()
      };
    }

    function saveData(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    // Notification functions
    function addNotification(message) {
      let notifications = JSON.parse(localStorage.getItem(NOTIFICATIONS_KEY)) || [];
      
      const newNotification = {
        id: Date.now(),
        message,
        timestamp: new Date().toISOString(),
        read: false
      };

      notifications.unshift(newNotification);
      if (notifications.length > 50) notifications.pop();

      localStorage.setItem(NOTIFICATIONS_KEY, JSON.stringify(notifications));
      
      // Request notification permission if not already granted
      if (Notification.permission !== 'granted') {
        Notification.requestPermission();
      }
    }

    function addDonatedItem(crop, quantity, date = new Date(), community = '', location = '') {
      const data = getStoredData();
      data.donated.push({
        crop,
        quantity: parseInt(quantity),
        date: date.toISOString(),
        community,
        location
      });
      saveData(data);
      
      // Add notification with community and location info
      const notificationMessage = `Donated ${quantity} ${crop} to ${community}${location ? ` in ${location}` : ''}`;
      addNotification(notificationMessage);
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        closeModal(event.target.id);
      }
    }

    function showTopAlert(message, type = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `top-alert ${type}`;
      alertDiv.textContent = message;
      document.body.prepend(alertDiv);
      
      setTimeout(() => alertDiv.classList.add('show'), 100);
      setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 500);
      }, 3000);
    }
  </script>
</body>
</html>